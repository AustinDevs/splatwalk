# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## What This Is

SplatWalk — a static demo site showcasing ground-level 3D viewing of land parcels using three rendering modes: Gaussian Splat, Panoramic Skybox, and Depth Mesh. Assets are generated by an ephemeral DigitalOcean H100 GPU pipeline and hosted on DO Spaces CDN.

## Commands

```bash
npm run dev          # Static file server for local development
```

No build step, no test suite, no linter. Pure static HTML/JS/CSS.

## Project Structure

```
index.html              # Demo page with three rendering modes
js/ground-demo.js       # 3D viewer (Three.js + GaussianSplats3D via importmap)
css/styles.css          # Base styles
scripts/
  run_demo_assets.sh    # Launch GPU droplet to generate demo assets
  setup-volume.sh       # Install runtime onto DO Volume (idempotent)
  cleanup-droplets.sh   # Destroy stale GPU droplets
  gpu/                  # Python scripts that run on the remote GPU droplet
    run_pipeline.sh     # Main pipeline orchestrator (5 stages)
    render_descent.py   # Stage 3: descent camera rendering + retraining
    generate_ground_views.py  # Stage 3.5: FLUX ControlNet + IP-Adapter
    generate_tiered_views.py  # Tiered view generation
    compress_splat.py   # Stage 5: pruning + .splat binary conversion
    quality_gate.py     # Confidence scoring
    generate_viewer_assets.py # Demo asset generation (cubemaps, panoramas, splat)
```

## How It Works

1. Default view: loads aukerman demo assets from DO Spaces CDN
2. `?manifest=https://...CDN.../manifest.json` overrides with a different asset set
3. CDN assets (DO Spaces) must have CORS configured to allow browser fetch
4. Three modes: Skybox (360 panorama), Depth Mesh (panorama on displacement sphere), Gaussian Splat (free camera 3D)
5. Gaussian Splat mode requires `crossOriginIsolated` (HTTPS + COEP/COOP headers from hosting platform)

## GPU Pipeline

Scripts in `scripts/gpu/`, fetched from GitHub at runtime for hotfixes. Launched via `scripts/run_demo_assets.sh`.

### Infrastructure

- **Everything-on-Volume**: Runtime (conda, repos, models ~36GB) lives on a persistent DO Volume at `/mnt/splatwalk/`. Droplets are stateless — attach Volume at boot, detach on self-destruct.
- `scripts/setup-volume.sh` — Installs full runtime onto Volume (idempotent)
- DO has a **1 GPU droplet limit** — always check/destroy existing before creating new

## Critical Technical Details

### Uniform Scene Scaling (.splat format)
Positions AND scales must be multiplied by the **same factor** (default 50x). Separate scale multipliers distort trained Gaussian overlap proportions, causing wash-out or speckle. Scene is centered at centroid before scaling.

### InstantSplat Training
- `n_views` is a **path component** (`sparse_{n_views}/0/`), NOT a camera count limit
- `Scene()` always starts from COLMAP, never from checkpoints
- Densification is disabled — initial point count determines final Gaussian count
- **Never retrain with FLUX-generated images** — even 500 iterations bloats Gaussian scales 4x

### PyTorch3D Compilation
Pre-built pip wheel has CPU-only `_C.so` (~1MB). GPU rasterization requires building from source with both `FORCE_CUDA=1` AND `TORCH_CUDA_ARCH_LIST="8.0;8.6;8.9;9.0"`. Properly compiled `_C.so` is ~24-27MB.

### Web Viewer
- CDN assets require CORS headers from DO Spaces; hosting platform must serve COEP/COOP headers for SharedArrayBuffer
- `computeSceneBounds()` only works for .splat files (reads binary format directly)
- GaussianSplats3D viewer options: `gpuAcceleratedSort`, `antialiased`, `kernel2DSize`, `sphericalHarmonicsDegree` are compile-time (set at construction, not runtime)

### COLMAP from cameras.json
cameras.json `rotation` field = R_c2w (camera-to-world). To get COLMAP format: `R_w2c = R_c2w.T`, `T_w2c = -R_w2c @ position`.

## Environment

`.env` is used by `scripts/run_demo_assets.sh` (GPU launcher), not by the static site. Key variables:
- `DO_API_TOKEN`, `DO_SPACES_KEY/SECRET`, `DO_VOLUME_ID` — DigitalOcean infra
- `DO_SSH_PRIVATE_KEY_PATH` — SSH key for GPU droplets (default `~/.ssh/splatwalk_gpu`)
- `GEMINI_API_KEY` — Scene captioning (Gemini 2.5 Flash)
- `SLACK_WEBHOOK_URL` — Pipeline progress notifications
- `GPU_DROPLET_SIZE` — `gpu-h100x1-80gb` (default) or `gpu-4000adax1-20gb` (budget)
